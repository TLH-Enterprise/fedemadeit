---
import type { MediaItem, Session } from "../data/portfolio";
import { Image } from "astro:assets";

interface Props {
	items: MediaItem[];
	sessions: Session[];
}

const { items, sessions } = Astro.props;

function getItemsBySession(items: MediaItem[], sessionId: string) {
	return items.filter((i) => i.session === sessionId);
}
---

<section class="gallery-section" id="galeria">
	<h2 class="section-title">Portafolio de trabajo</h2>
	<p class="section-subtitle script">Federico Rios</p>

	{sessions.map((session) => {
		const sessionItems = getItemsBySession(items, session.id);
		const sessionPhotos = sessionItems.filter((i) => i.type === "photo");
		const photosList = sessionPhotos.map((p) => ({ src: p.thumbnail, title: p.title || "Foto" }));
		return (
			<div
				class="session-block"
				id={`sesion-${session.id}`}
				data-photos={JSON.stringify(photosList)}
			>
				<h3 class="session-title">{session.name}</h3>
				<div class="grid grid-vertical">
					{sessionItems.length === 0 ? (
						<p class="session-empty">Próximamente</p>
					) : sessionItems.map((item) =>
						item.type === "video" && item.videoUrl ? (
							<div class="card">
								<div class="card-thumb">
									<video
										class="card-video"
										poster={item.thumbnail}
										src={item.videoUrl}
										controls
										playsinline
										preload="metadata"
										title={item.title || "Video"}
										aria-label={item.title ? `Video: ${item.title}. Controles de reproducción.` : "Video con controles de reproducción"}
									>
										<track kind="captions" src="/captions/empty.vtt" srclang="es" label="Español" default />
									</video>
								</div>
								{item.title && <p class="card-title">{item.title}</p>}
							</div>
						) : (
							<button
								type="button"
								class="card card-photo"
								data-photo-src={item.thumbnail}
								data-photo-title={item.title}
								data-photo-index={sessionPhotos.findIndex((p) => p.id === item.id)}
								aria-label={item.title ? `Ver ${item.title} en grande` : "Ver foto en grande"}
							>
								<div class="card-thumb">
									<Image
										src={item.thumbnail}
										alt={item.title || "Foto del portafolio"}
										width={260}
										height={462}
										loading="lazy"
										class="card-thumb-img"
									/>
								</div>
								{item.title && <p class="card-title">{item.title}</p>}
							</button>
						)
					)}
				</div>
			</div>
		);
	})}
</section>

<div class="lightbox" id="lightbox" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Ver foto">
	<button type="button" class="lightbox-close" aria-label="Cerrar" data-lightbox-close>×</button>
	<button type="button" class="lightbox-prev" aria-label="Foto anterior" data-lightbox-prev>
		<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
	</button>
	<button type="button" class="lightbox-next" aria-label="Foto siguiente" data-lightbox-next>
		<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
	</button>
	<div class="lightbox-backdrop" data-lightbox-close></div>
	<div class="lightbox-content">
		<img class="lightbox-img" src="" alt="Vista ampliada de la foto del portafolio" data-lightbox-img />
		<p class="lightbox-title" data-lightbox-title></p>
		<p class="lightbox-counter" data-lightbox-counter></p>
	</div>
</div>

<style>
	.gallery-section {
		max-width: 1200px;
		margin: 0 auto;
		padding: 4rem 1.5rem 5rem;
	}

	.section-title {
		font-family: var(--font-display);
		font-size: clamp(1.75rem, 4vw, 2.25rem);
		text-align: center;
		text-transform: uppercase;
		letter-spacing: 0.08em;
		color: var(--text-primary);
		margin-bottom: 0.25rem;
	}

	.section-subtitle.script {
		font-family: var(--font-script);
		font-size: 1.75rem;
		font-weight: 700;
		text-align: center;
		color: var(--accent-green);
		margin-bottom: 3rem;
	}

	.session-block {
		margin-bottom: 3.5rem;
	}

	.session-title {
		font-family: var(--font-body);
		font-size: 1.1rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.1em;
		color: var(--text-primary);
		margin-bottom: 1.25rem;
		padding-bottom: 0.5rem;
		border-bottom: 1px solid rgba(255, 255, 255, 0.1);
	}

	.session-empty {
		color: var(--text-muted);
		font-size: 0.95rem;
		padding: 1rem 0;
	}

	.grid {
		display: grid;
		gap: 1.5rem;
	}

	.grid-vertical {
		grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
	}

	.grid-horizontal {
		grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
	}

	.card {
		display: block;
		background: var(--bg-card);
		border-radius: 8px;
		overflow: hidden;
		border: 1px solid rgba(255, 255, 255, 0.06);
		transition: transform 0.2s, box-shadow 0.2s;
	}

	.card:hover {
		transform: translateY(-4px);
		box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
	}

	.card-thumb {
		position: relative;
		aspect-ratio: 9/16;
		overflow: hidden;
	}

	.grid-horizontal .card-thumb {
		aspect-ratio: 16/10;
	}

	.card-thumb img,
	.card-thumb .card-thumb-img,
	.card-thumb .card-video {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}

	.card-video {
		background: #000;
	}

	.card-title {
		font-size: 0.9rem;
		font-weight: 500;
		padding: 0.75rem 1rem;
		color: var(--text-muted);
	}

	.card-photo {
		width: 100%;
		text-align: left;
		cursor: pointer;
		font: inherit;
		color: inherit;
		border: none;
		background: none;
		padding: 0;
	}

	/* Lightbox */
	.lightbox {
		position: fixed;
		inset: 0;
		z-index: 200;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 3rem 4rem;
		opacity: 0;
		visibility: hidden;
		transition: opacity 0.25s, visibility 0.25s;
	}

	.lightbox.is-open {
		opacity: 1;
		visibility: visible;
	}

	.lightbox-backdrop {
		position: absolute;
		inset: 0;
		background: rgba(0, 0, 0, 0.92);
		cursor: pointer;
	}

	.lightbox-content {
		position: relative;
		z-index: 2;
		display: flex;
		flex-direction: column;
		align-items: center;
		max-width: 95vw;
		max-height: 90vh;
	}

	.lightbox-img {
		max-width: 100%;
		max-height: 80vh;
		width: auto;
		height: auto;
		object-fit: contain;
		border-radius: 8px;
		box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
	}

	.lightbox-title {
		margin-top: 1rem;
		font-size: 1rem;
		font-weight: 500;
		color: var(--text-primary);
	}

	.lightbox-counter {
		margin-top: 0.25rem;
		font-size: 0.9rem;
		color: var(--text-muted);
	}

	.lightbox-close {
		position: absolute;
		top: 1.5rem;
		right: 1.5rem;
		z-index: 3;
		width: 48px;
		height: 48px;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 2rem;
		line-height: 1;
		color: var(--text-primary);
		background: rgba(255, 255, 255, 0.1);
		border: 1px solid rgba(255, 255, 255, 0.2);
		border-radius: 50%;
		cursor: pointer;
		transition: background 0.2s;
	}

	.lightbox-close:hover {
		background: rgba(255, 255, 255, 0.2);
	}

	.lightbox-prev,
	.lightbox-next {
		position: absolute;
		top: 50%;
		transform: translateY(-50%);
		z-index: 3;
		width: 52px;
		height: 52px;
		display: flex;
		align-items: center;
		justify-content: center;
		color: var(--text-primary);
		background: rgba(255, 255, 255, 0.1);
		border: 1px solid rgba(255, 255, 255, 0.2);
		border-radius: 50%;
		cursor: pointer;
		transition: background 0.2s;
	}

	.lightbox-prev {
		left: 1.5rem;
	}

	.lightbox-next {
		right: 1.5rem;
	}

	.lightbox-prev:hover,
	.lightbox-next:hover {
		background: rgba(255, 255, 255, 0.2);
	}

	@media (max-width: 600px) {
		.grid-vertical {
			grid-template-columns: repeat(2, 1fr);
			gap: 0.75rem;
		}

		.grid-horizontal {
			grid-template-columns: 1fr;
		}

		.lightbox {
			padding: 2rem 1rem;
		}

		.lightbox-prev {
			left: 0.5rem;
		}

		.lightbox-next {
			right: 0.5rem;
		}

		.lightbox-close {
			top: 0.75rem;
			right: 0.75rem;
		}
	}
</style>

<script>
	const lightbox = document.getElementById("lightbox");
	const lightboxImg = document.querySelector("[data-lightbox-img]");
	const lightboxTitle = document.querySelector("[data-lightbox-title]");
	const lightboxCounter = document.querySelector("[data-lightbox-counter]");
	const closeTriggers = document.querySelectorAll("[data-lightbox-close]");
	const prevBtn = document.querySelector("[data-lightbox-prev]");
	const nextBtn = document.querySelector("[data-lightbox-next]");

	let photos: { src: string; title: string }[] = [];
	let currentIndex = 0;

	function openLightbox(photosList: { src: string; title: string }[], index: number) {
		photos = photosList;
		currentIndex = index;
		updateLightboxImage();
		if (lightbox) {
			lightbox.classList.add("is-open");
			lightbox.setAttribute("aria-hidden", "false");
			document.body.style.overflow = "hidden";
		}
		prevBtn?.setAttribute("aria-hidden", photos.length <= 1 ? "true" : "false");
		nextBtn?.setAttribute("aria-hidden", photos.length <= 1 ? "true" : "false");
	}

	function closeLightbox() {
		if (lightbox) {
			lightbox.classList.remove("is-open");
			lightbox.setAttribute("aria-hidden", "true");
			document.body.style.overflow = "";
		}
	}

	function updateLightboxImage() {
		if (!photos.length || !lightboxImg) return;
		const photo = photos[currentIndex];
		(lightboxImg as HTMLImageElement).src = photo.src;
		(lightboxImg as HTMLImageElement).alt = photo.title;
		if (lightboxTitle) lightboxTitle.textContent = photo.title;
		if (lightboxCounter) lightboxCounter.textContent = `${currentIndex + 1} / ${photos.length}`;
	}

	function goPrev() {
		if (photos.length <= 1) return;
		currentIndex = currentIndex === 0 ? photos.length - 1 : currentIndex - 1;
		updateLightboxImage();
	}

	function goNext() {
		if (photos.length <= 1) return;
		currentIndex = currentIndex === photos.length - 1 ? 0 : currentIndex + 1;
		updateLightboxImage();
	}

	document.querySelectorAll(".card-photo").forEach((btn) => {
		btn.addEventListener("click", () => {
			const sessionBlock = btn.closest(".session-block");
			const photosJson = sessionBlock?.getAttribute("data-photos");
			if (!photosJson) return;
			const photosList = JSON.parse(photosJson) as { src: string; title: string }[];
			const index = parseInt(btn.getAttribute("data-photo-index") ?? "0", 10);
			openLightbox(photosList, index);
		});
	});

	closeTriggers.forEach((el) => el.addEventListener("click", closeLightbox));
	prevBtn?.addEventListener("click", goPrev);
	nextBtn?.addEventListener("click", goNext);

	lightbox?.addEventListener("click", (e) => {
		if (e.target === lightbox) closeLightbox();
	});

	document.addEventListener("keydown", (e) => {
		if (e.key === "Escape" && lightbox?.classList.contains("is-open")) closeLightbox();
		if (e.key === "ArrowLeft" && lightbox?.classList.contains("is-open")) goPrev();
		if (e.key === "ArrowRight" && lightbox?.classList.contains("is-open")) goNext();
	});
</script>
